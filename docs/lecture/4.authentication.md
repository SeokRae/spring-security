# 4. 인증(Authentication) 프로세스 구현

## 4.1. 실전 프로젝트 구성

- build.gradle 설정

```
plugins {
    id 'org.springframework.boot' version '2.3.3.RELEASE'
    id 'io.spring.dependency-management' version '1.0.10.RELEASE'
    id 'java'
}

group = 'kr.seok'
version = '0.0.1-SNAPSHOT'
sourceCompatibility = '1.8'

configurations {
    compileOnly {
        extendsFrom annotationProcessor
    }
}

repositories {
    mavenCentral()
}

dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-web'
    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
    implementation 'org.springframework.boot:spring-boot-starter-security'

    implementation 'org.springframework.boot:spring-boot-starter-thymeleaf'
    // https://mvnrepository.com/artifact/org.thymeleaf.extras/thymeleaf-extras-springsecurity5
    implementation 'org.thymeleaf.extras:thymeleaf-extras-springsecurity5:3.0.4.RELEASE'

    // https://mvnrepository.com/artifact/org.modelmapper/modelmapper
    implementation 'org.modelmapper:modelmapper:2.3.0'

    developmentOnly 'org.springframework.boot:spring-boot-devtools'

    compileOnly 'org.projectlombok:lombok'
    annotationProcessor 'org.projectlombok:lombok'

//    runtimeOnly 'org.postgresql:postgresql'
    /* h2 */
    implementation 'com.h2database:h2'

    annotationProcessor 'org.springframework.boot:spring-boot-configuration-processor'

    testImplementation('org.springframework.boot:spring-boot-starter-test') {
        exclude group: 'org.junit.vintage', module: 'junit-vintage-engine'
    }
    testImplementation 'org.springframework.security:spring-security-test'
}

test {
    useJUnitPlatform()
}
```

- SecurityConfig 설정 

```java
@Configuration
@EnableWebSecurity
public class SecurityConfig extends WebSecurityConfigurerAdapter {
    /* Password Encode */
    @Bean
    public PasswordEncoder passwordEncoder() {
        return PasswordEncoderFactories.createDelegatingPasswordEncoder();
    }
    /* AuthenticationManagerBuilder InMemoryAuthentication 등록 */
    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {
        String password = passwordEncoder().encode("1234");
        auth.inMemoryAuthentication().withUser("user").password(password).roles("USER");
        auth.inMemoryAuthentication().withUser("manager").password(password).roles("MANAGER");
        auth.inMemoryAuthentication().withUser("admin").password(password).roles("ADMIN");
    }
    /* HttpSecurity Authentication AntMatcher */
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http
                .authorizeRequests()
                .antMatchers("/").permitAll()
                .antMatchers("/mypage").hasRole("USER")
                .antMatchers("/messages").hasRole("MANAGER")
                .antMatchers("/config").hasRole("ADMIN")
                .anyRequest().authenticated()
            .and()
                .formLogin()
        ;
    }
}
```

## 4.2. 메뉴 권한 및 WebIgnore 설정

- SecurityConfig 설정

```java
@Configuration
@EnableWebSecurity
public class SecurityConfig extends WebSecurityConfigurerAdapter {
    /* Password Encode */
    @Bean
    public PasswordEncoder passwordEncoder() {
        return PasswordEncoderFactories.createDelegatingPasswordEncoder();
    }
    /* static resource security 에서 제외 처리 */
    @Override
    public void configure(WebSecurity web) {
        web.ignoring().requestMatchers(PathRequest.toStaticResources().atCommonLocations());
    }
    /* AuthenticationManagerBuilder InMemoryAuthentication 등록 */
    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {
        String password = passwordEncoder().encode("1234");
        auth.inMemoryAuthentication().withUser("user").password(password).roles("USER");
        auth.inMemoryAuthentication().withUser("manager").password(password).roles("MANAGER");
        auth.inMemoryAuthentication().withUser("admin").password(password).roles("ADMIN");
    }

    /* HttpSecurity Authentication AntMatcher */
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http
                .authorizeRequests()
                .antMatchers("/").permitAll()
                .antMatchers("/mypage").hasRole("USER")
                .antMatchers("/messages").hasRole("MANAGER")
                .antMatchers("/config").hasRole("ADMIN")
                .anyRequest().authenticated()
            .and()
                .formLogin()
        ;
    }
}
```

## 4.3. Form 인증

### 4.3.1. User 등록 / PasswordEncoder
- PasswordEncoder
    - 비밀번호를 안전하게 암호화 하도록 제공
    - SpringSecurity 5.0 이전에는 기본 PasswordEncoder 가 평문을 지원하는 NoOpPasswordEncoder (현재는 Deprecated)

- 생성
    
### 4.3.2. CustomUserDetailsService
### 4.3.3. CustomAuthenticationProvider
### 4.3.4. Custom Login Form Page
### 4.3.5. 로그아웃 및 화면 보안 처리
### 4.3.6. WebAuthenticationDetails, AuthenticationDetailsSource
### 4.3.7. CustomAuthenticationSuccessHandler
### 4.3.8. CustomAuthenticationFailureHandler
### 4.3.9. Access Denied
### 4.3.10. CSRF, CsrfFilter
### 4.3.11. 인증 사용자 정보 구하기

## 4.4. Ajax 인증

### 4.4.1. 흐름 및 개요
### 4.4.2. AjaxAuthenticationFilter
### 4.4.3. AjaxAuthenticationProvider
### 4.4.4. AjaxAuthenticationSuccessHandler
### 4.4.5. AjaxAuthenticationFailureHandler
### 4.4.6. AjaxLoginUrlAuthenticationEntryPoint
### 4.4.7. AjaxAccessDeniedHandler
### 4.4.8. DSL로 Config 설정하기
### 4.4.9. 로그인 Ajax 구현 & CSRF