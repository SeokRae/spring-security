# 2. 스프링 시큐리티 기본 API & Filter 이해

## 2.1. 인증 API

### 2.1.1. 프로젝트 구성 및 의존성 추가 

- 서버가 기동되면 스프링 시큐리티의 초기화 작업 및 보안 설정이 이루어진다
    - 별도의 설정이나 구현을 하지 않아도 기본적인 웹 보안 기능이 현재 시스템에 연동되어 작동함
    - 모든 요청은 인증이 되어야 자원에 접근이 가능하다
        1. 인증 방식은 폼 로그인 방식과 httpBasic 로그인 방식을 제공한다
        2. 기본 로그인 페이지 제공한다
        3. 기본 계정 한 개 제공한다 – username : user / password : 랜덤 문자열

- 개선할 사항
    - 계정 추가
    - 권한 추가
    - DB 연동
    - 기본적인 보안 기능 외에 시스템에서 필요로 하는 더 세부적이고 추가적인 보안기능이 필요

### 2.1.2. 사용자 정의 보안 기능 구현

- WebSecurityConfigurerAdapter (핵심)
    - 웹 보안 기능 초기화 및 활성화
    - HttpSecurity 생성
        - 인증 & 인가 API 제공

- WebSecurityConfigurerAdapter
![WebSecurityConfigurerAdapter](/docs/img/diagram_WebSecurityConfigurerAdapter.png "WebSecurityConfigurerAdapter")

- HttpSecurity
![HttpSecurity](/docs/img/diagram_HttpSecurity.png "HttpSecurity")

- [SecurityConfig.java](/security-basic-api/src/main/java/kr/seok/SecurityConfig.java)

- Debug
```
- SecurityConfig Debug
    1. WebSecurityConfigurerAdapter 클래스의 기본 값 설정 디버깅

    2. HttpSecurity 기본 설정
        1) getHttp()
        2) configure()

```

### 2.1.3. HTTP Basic 인증

```
- Http는 자체적인 인증 관련 기능을 제공하며 HTTP 표준에 정의된 가장 단순한 인증 기법이다.
- 간단한 설정과 Stateless가 장점 - Session Cookie(JESSIONID) 사용하지 않음
- 보호차원 접근 시 서버가 클라이언트에게 401 UnAuthorized 응답과 함께 WWW-Authenticate header를 기술해서 인증 요구를 보냄
- Client Id: Password 값을 Base64로 Encoding한 문자열을 Authorization Header에 추가한 뒤 Server에게 Resource를 요청
    - Authorization: Basic cmVzdDpyZXN0
- ID, Password가 Base64로 Encoding되어 있어 ID, Password가 외부에 쉽게 노출되는 구조이기 때문에 SSL이나 TLS는 필수이다.
```

### 2.1.4. BasicAuthenticationFilter

- [RFC 7617](https://tools.ietf.org/html/rfc7617)
    - ![RFC 7617 Diagram](/docs/img/flow_BasicAuthenticationFilter.png)

- 인증 프로토콜과 헤더
```
- HTTP는 필요에 따라 고쳐 쓸 수 있는 제어 헤더를 통해, 다른 인증 프로토콜에 맞추어 확장할 수 있는 프레임워크를 제공한다.
- 헤더의 형식과 내용은 인증 프로토콜에 따라 달라진다.
- 인증 프로토콜은 HTTP 인증 헤더에 기술되어 있다.
- HTTP에는 "기본 인증"과 "DIGEST 인증"이 있다.
```

- Basic Authentication 의 문제점
```
- 기본 인증의 보안 문제
    - 기본 인증은 단순하고 편리하지만 안심할 수 없다.
    - 기본인증은 악의적이지 않은 누군가가 의도하지 않게 리소스에 접근하는 것을 막는데 사용하거나 SSL 같은 암호 기술과 혼용 해야 한다.
    - base64 인코딩된 값은 쉽게 디코딩할 수 있다.
    - 제 3자는 사용자 이름과 비밀번호를 캡처하여 악용할 수 있다.
    - Proxy나 중개자가 개입하는 경우 정상적인 동작을 보장할 수 없다.
    - 기본인증은 가짜 서버의 위장에 취약하다.
```

### 2.1.5. Form 인증
- 인증 API
```
- 인증
    - formLogin()
    - loginPage("/loginPage")
        - 스프링 시큐리티의 기본 로그인 페이지를 설정
    - defaultSuccessUrl("/")
        - 로그인 성공 시 redirect 되는 URL 설정
    - usernameParameter("userId")
        - 로그인 기본페이지의 username 의 name 값을 설정
    - passwordParameter("passwd")
        - 로그인 기본페이지의 password 의 name 값을 설정
    - loginProcessingUrl("/login_proc")
        - ?
    - successHandler(new AuthenticationSuccessHandler() {})
        - 로그인 성공 시 실행되는 Handler
    - failureHandler(new AuthenticationFailureHandler() {})
        - 로그인 실패 시  실행되는 Handler
    - permitAll()
        - formLogin에 접근하기 위한 url의 접근 권한 all 설정
```

### 2.1.6. UserPasswordAuthenticationFilter
- Authentication
![UserPasswordAuthenticationFilter](/docs/img/flow_UsernamePasswordAuthenticationFilter.png)

### 2.1.7. Logout, LogoutFilter
- LogoutFilter Flow
![LogoutFilter](/docs/img/flow_LogoutFilter.png)

- Logout
    - request("/logout")
    - 세션 무효화
    - 인증 토큰 삭제
    - 쿠키정보 삭제,
    - 로그인 페이지로 리다이렉트

### 2.1.8. Remember Me 인증

- RememberMe 인증이란 ?
- form 인증 방식에 추가되는 기능
    - 세션이 만료되고 웹 브라우저가 종료된 이후에도 어플리케이션이 사용자를 기억하는 기능

- remember-me 쿠키
    - remember-me 기능을 활성화시킨 상태에서 인증 프로세스를 처리 시 서버는 remember-me 쿠키를 응답 헤더에 실어서 보내게 된다.
    - 사용자는 remember-me 쿠키의 만료일 전까지 세션 유지가 가능하다.
        - 세션이 유실되는 경우에도 remember-me 쿠키가 존재하는 경우 쿠키 안에 사용자 정보를 통해 토큰 기반 인증하여 토큰 검증 시 로그인 유지가 가능

- 라이프 사이클
    - 인증 성공
        - remember-me 쿠키 설정
    - 인증 실패
        - 쿠키 존재 시 쿠키 무효화
    - 로그 아웃
        - 쿠키 존재 시 쿠키 무효화

- 로그인 시 세션 생성 플로우

- JSESSIONID 삭제 시 remember-me 쿠키가 인증 토큰을 재발급 하는 플로우
![RememberMe 생성 확인](/docs/img/browser/rememberMe.png)

### 2.1.9. RememberMeAuthenticationFilter

- remember-me 발급 플로우
    - 

- Remember-Me가 존재하는 경우 JSESSIONID가 유실되는 경우에도 인증처리가 가능
    - SpringSecurity의 RememberMeAuthenticationFilter 에서 request Header에 Cookie를 확인하여 userId와 userPw값으로 user 객체를 얻어 인증처리 해버림

### 2.1.10. AnonymousAuthenticationFilter

### 2.1.11. 동시 세션 제어

### 2.1.12. 세션 고정 보호

### 2.1.13. 세션 정책

### 2.1.14. SessionManagementFilter

### 2.1.15. ConcurrentSessionFilter

### 2.1.16. 권한 설정

### 2.1.17 표현식

## 2.2. 인증 / 인가 API

### 2.2.1. ExceptionTranslationFilter

### 2.2.2. AuthenticationException

### 2.2.3. AccessDeniedException

### 2.2.4. RequestCacheAwareFilter