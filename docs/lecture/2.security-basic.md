# 2. 스프링 시큐리티 기본 API & Filter 이해

## 2.1. 인증 API

### 2.1.1. 프로젝트 구성 및 의존성 추가 

- 서버가 기동되면 스프링 시큐리티의 초기화 작업 및 보안 설정이 이루어진다
    - 별도의 설정이나 구현을 하지 않아도 기본적인 웹 보안 기능이 현재 시스템에 연동되어 작동함
    - 모든 요청은 인증이 되어야 자원에 접근이 가능하다
        1. 인증 방식은 폼 로그인 방식과 httpBasic 로그인 방식을 제공한다
        2. 기본 로그인 페이지 제공한다
        3. 기본 계정 한 개 제공한다 – username : user / password : 랜덤 문자열

- 개선할 사항
    - 계정 추가
    - 권한 추가
    - DB 연동
    - 기본적인 보안 기능 외에 시스템에서 필요로 하는 더 세부적이고 추가적인 보안기능이 필요

### 2.1.2. 사용자 정의 보안 기능 구현

- WebSecurityConfigurerAdapter (핵심)
    - 웹 보안 기능 초기화 및 활성화
    - HttpSecurity 생성
        - 인증 & 인가 API 제공

- WebSecurityConfigurerAdapter
![WebSecurityConfigurerAdapter](/docs/img/diagram_WebSecurityConfigurerAdapter.png "WebSecurityConfigurerAdapter")

- HttpSecurity
![HttpSecurity](/docs/img/diagram_HttpSecurity.png "HttpSecurity")

- [SecurityConfig.java](/security-basic-api/src/main/java/kr/seok/SecurityConfig.java)
```java
@Configuration
@EnableWebSecurity
public class SecurityConfig extends WebSecurityConfigurerAdapter {
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        // 인가 정책
        http
                .authorizeRequests()
                .anyRequest().authenticated();
        // 인증 정책
        http
                .formLogin();
    }
}
```
- Debug
```
- SecurityConfig Debug
    1. WebSecurityConfigurerAdapter 클래스의 기본 값 설정 디버깅
        1) LogFactory.getLog(WebSecurityConfigurerAdapter.class);
        2) HeaderContentNegotiationStrategy
        3) ObjectPostProcessor<Object>
            - SecurityConfig 클래스에 @EnableWebSecurity and @Configuration 설정이 필요하도록 알려주는 인터페이스
        4) AuthenticationConfiguration
        5) AuthenticationManagerBuilder
        6) AuthenticationManagerBuilder
        7) boolean disableLocalConfigureAuthenticationBldr
        8) boolean authenticationManagerInitialized
        9) AuthenticationManager
        10) AuthenticationTrustResolverImpl implements AuthenticationTrustResolver
            - 인증 클래스
                - Authentication 토큰의 인증 값을 평가하는 클래스
                - isAnonymous or isRememberMe
        11) HttpSecurity
        12) boolean disableDefaults
        
    2. HttpSecurity 기본 설정
        1) getHttp()
            - AuthenticationEventPublisher or DefaultAuthenticationEventPublisher
                - Success or Failure 시 일어나는 이벤트 등록 클래스
            - AuthenticationManager
            - HttpSecurity(objectPostProcessor, authenticationBuilder, sharedObjects);
                - objectPostProcessor
                    - SecurityConfig 클래스에 @EnableWebSecurity and @Configuration 설정이 필요하도록 알려주는 인터페이스
                - authenticationBuilder
                    - localConfigureAuthenticationBldr.build();
                    - AuthenticationManager
                - sharedObjects
                    - localConfigureAuthenticationBldr.getSharedObjects()
                    - UserDetailsService.class
                    - ApplicationContext.class
                    - ContentNegotiationStrategy.class
                    - AuthenticationTrustResolver.class
            - http
                - .csrf().and() - CsrfConfigurer
                - .addFilter(new WebAsyncManagerIntegrationFilter())
                - .exceptionHandling().and() - ExceptionHandlingConfigurer
                - .headers().and() - HeadersConfigurer
                - .sessionManagement().and() - SessionManagementConfigurer
                - .securityContext().and() - SecurityContextConfigurer
                - .requestCache().and() - RequestCacheConfigurer
                - .anonymous().and() - AnonymousConfigurer
                - .servletApi().and() - ServletApiConfigurer
                - .apply(new DefaultLoginPageConfigurer<>()).and() - DefaultLoginPageConfigurer
                - .logout();
                
        2) configure() 추가 설정
            - authorizeRequest()
                - ApplicationContext()
                    - getContext()
                        - getSharedObject() - ApplicationContext
                    - getOrApply() - ExpressionUrlAuthorizationConfigurer
                        - ExpressionUrlAuthorizationConfigurer
                            - AbstractInterceptUrlConfigurer
                                - AbstractHttpConfigurer
                                    - SecurityConfigurerAdapter
                                        - CompositeObjectPostProcessor
                                            - List<ObjectPostProcessor<?>>
                            - AbstractConfigAttributeRequestMatcherRegistry
                                - AbstractRequestMatcherRegistry
                                    - AbstractInterceptUrlRegistry
                            - ExpressionInterceptUrlRegistry
                    - getRegistry()
    
            - .anyRequest()
                -  requestMatchers(ANY_REQUEST)
                    - chainRequestMatchers()
                        - chainRequestMatchersInternal();
                            - AuthorizedUrl(requestMatchers)
    
            - .authenticated()
                - access(authenticated)
                    - interceptUrl(requestMatchers, SecurityConfig.createList(attribute));
                        - REGISTRY.addMapping(new AbstractConfigAttributeRequestMatcherRegistry.UrlMapping(requestMatcher, configAttributes));
                            - this.urlMappings.add(urlMapping);
                    - ExpressionUrlAuthorizationConfigurer.this.REGISTRY;
                    
            - and()
                - ExpressionUrlAuthorizationConfigurer.this.and()
    
            - formLogin()
                - getOrApply() - FormLoginConfigurer
                - getConfigurer() - FormLoginConfigurer
                - apply() - FormLoginConfigurer
                    - addObjectPostProcessor() - SecurityConfigurerAdapter
                    - setBuilder() - FormLoginConfigurer
                    - add() - FormLoginConfigurer
    
            - and()
                - ExpressionUrlAuthorizationConfigurer.this.and()
    
            - httpBasic()
                - getOrApply() - HttpBasicConfigurer
                - getConfigurer() - HttpBasicConfigurer
                - apply() - HttpBasicConfigurer
                    - addObjectPostProcessor() - SecurityConfigurerAdapter
                    - setBuilder() - HttpBasicConfigurer
                    - add() - HttpBasicConfigurer
```

### 2.1.3. HTTP Basic 인증

```
- Http는 자체적인 인증 관련 기능을 제공하며 HTTP 표준에 정의된 가장 단순한 인증 기법이다.
- 간단한 설정과 Stateless가 장점 - Session Cookie(JESSIONID) 사용하지 않음
- 보호차원 접근 시 서버가 클라이언트에게 401 UnAuthorized 응답과 함께 WWW-Authenticate header를 기술해서 인증 요구를 보냄
- Client Id: Password 값을 Base64로 Encoding한 문자열을 Authorization Header에 추가한 뒤 Server에게 Resource를 요청
    - Authorization: Basic cmVzdDpyZXN0
- ID, Password가 Base64로 Encoding되어 있어 ID, Password가 외부에 쉽게 노출되는 구조이기 때문에 SSL이나 TLS는 필수이다.
```

### 2.1.4. BasicAuthenticationFilter

[RFC 7617](https://tools.ietf.org/html/rfc7617)
![RFC 7617 Diagram](/docs/img/diagram_BasicAuthenticationFilter.png)

- 인증 프로토콜과 헤더
```
- HTTP는 필요에 따라 고쳐 쓸 수 있는 제어 헤더를 통해, 다른 인증 프로토콜에 맞추어 확장할 수 있는 프레임워크를 제공한다.
- 헤더의 형식과 내용은 인증 프로토콜에 따라 달라진다.
- 인증 프로토콜은 HTTP 인증 헤더에 기술되어 있다.
- HTTP에는 "기본 인증"과 "DIGEST 인증"이 있다.
```

- Basic Authentication 의 문제점
```
- 기본 인증의 보안 문제
    - 기본 인증은 단순하고 편리하지만 안심할 수 없다.
    - 기본인증은 악의적이지 않은 누군가가 의도하지 않게 리소스에 접근하는 것을 막는데 사용하거나 SSL 같은 암호 기술과 혼용 해야 한다.
    - base64 인코딩된 값은 쉽게 디코딩할 수 있다.
    - 제 3자는 사용자 이름과 비밀번호를 캡처하여 악용할 수 있다.
    - Proxy나 중개자가 개입하는 경우 정상적인 동작을 보장할 수 없다.
    - 기본인증은 가짜 서버의 위장에 취약하다.
```
### 2.1.5. Form 인증
- 인증 API 확인하기
```
- 인증
    - formLogin()
    - loginPage("/loginPage")
        - 스프링 시큐리티의 기본 로그인 페이지를 설정
    - defaultSuccessUrl("/")
        - 로그인 성공 시 redirect 되는 URL 설정
    - usernameParameter("userId")
        - 로그인 기본페이지의 username 의 name 값을 설정
    - passwordParameter("passwd")
        - 로그인 기본페이지의 password 의 name 값을 설정
    - loginProcessingUrl("/login_proc")
        - ?
    - successHandler(new AuthenticationSuccessHandler() {})
        - 로그인 성공 시 실행되는 Handler
    - failureHandler(new AuthenticationFailureHandler() {})
        - 로그인 실패 시  실행되는 Handler
    - permitAll()
        - formLogin에 접근하기 위한 url의 접근 권한 all 설정
```
    
```java
@Configuration
@EnableWebSecurity
public class SecurityConfig extends WebSecurityConfigurerAdapter {
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        // 인가 정책
        http
                .authorizeRequests()
                .anyRequest().authenticated();
        // 인증 정책
        http
                .formLogin()
//                .loginPage("/loginPage")
                .defaultSuccessUrl("/")
                .failureUrl("/login")
                .usernameParameter("userId")
                .passwordParameter("passwd")
                .loginProcessingUrl("/login_proc")
                .successHandler(new AuthenticationSuccessHandler() {
                    @Override
                    public void onAuthenticationSuccess(HttpServletRequest request, HttpServletResponse response, Authentication authentication) throws IOException, ServletException {
                        System.out.println("authentication : " + authentication.getName());
                        response.sendRedirect("/");
                    }
                })
                .failureHandler(new AuthenticationFailureHandler() {
                    @Override
                    public void onAuthenticationFailure(HttpServletRequest request, HttpServletResponse response, AuthenticationException exception) throws IOException, ServletException {
                        System.out.println("exception" + exception.getMessage());
                        response.sendRedirect("/login");
                    }
                })
                .permitAll();
    }
}
```

### 2.1.6. UserPasswordAuthenticationFilter
```
- FormLogin API 의 Flow 확인
    - formLogin() 설정 시 - FormLoginConfigurer
        1. AbstractAuthenticationFilterConfigurer 추상클래스에 UsernamePasswordAuthenticationFilter 등록
            1.1. AbstractHttpConfigurer
                1.1.1. SecurityConfigurerAdapter
                    1.1.1.1. CompositeObjectPostProcessor()
                        1.1.1.1.1. List<ObjectPostProcessor<?>>
            1.2. SavedRequestAwareAuthenticationSuccessHandler
                1.2.1. SimpleUrlAuthenticationSuccessHandler
                    1.2.1.1. AbstractAuthenticationTargetUrlRequestHandler
                        - DefaultRedirectStrategy
                        - targetUrlParameter
                        - defaultTargetUrl
                        - alwaysUseDefaultTargetUrl
                        - useReferer
                        - DefaultRedirectStrategy
                1.2.2. HttpSessionRequestCache
                    - PortResolverImpl
                    - createSessionAllowed
                    - requestMatcher
                    - sessionAttrName
                1.2.3. AuthenticationSuccessHandler
                1.2.4. setLoginPage()
                    1.2.4.1. LoginUrlAuthenticationEntryPoint
                        - PortMapperImpl
                        - PortResolverImpl
                            - PortMapperImpl
                        - loginFormUrl
                        - forceHttps
                        - useForward
                        - DefaultRedirectStrategy
            1.3. AbstractAuthenticationProcessingFilter

    - Custom - AbstractAuthenticationFilterConfigurer
        - defaultSuccessUrl()
            - SavedRequestAwareAuthenticationSuccessHandler
                - setDefaultTargetUrl()
                - setAlwaysUseDefaultTargetUrl()
                    - AbstractAuthenticationTargetUrlRequestHandler
                - successHandler()
        - failureUrl()
            - failureHandler() - SimpleUrlAuthenticationFailureHandler
        - loginProcessingUrl()
            - setRequiresAuthenticationRequestMatcher()
        - successHandler()
        - failureHandler()
        - permitAll()

    - init()
        - getHttp()
```

- FilterChain
```
0 = {ApplicationFilterConfig@8919} "ApplicationFilterConfig[name=characterEncodingFilter, filterClass=org.springframework.boot.web.servlet.filter.OrderedCharacterEncodingFilter]"
1 = {ApplicationFilterConfig@8920} "ApplicationFilterConfig[name=formContentFilter, filterClass=org.springframework.boot.web.servlet.filter.OrderedFormContentFilter]"
2 = {ApplicationFilterConfig@8921} "ApplicationFilterConfig[name=requestContextFilter, filterClass=org.springframework.boot.web.servlet.filter.OrderedRequestContextFilter]"
3 = {ApplicationFilterConfig@8922} "ApplicationFilterConfig[name=springSecurityFilterChain, filterClass=org.springframework.boot.web.servlet.DelegatingFilterProxyRegistrationBean$1]"
    0 = {WebAsyncManagerIntegrationFilter@7560} 
    1 = {SecurityContextPersistenceFilter@8886}
        - SecurityContextRepository
            - SecurityContextHolder.setContext()
 
    2 = {HeaderWriterFilter@8900} 
    3 = {CsrfFilter@8901} 
    4 = {LogoutFilter@8902} 
        - SecurityContextHolder.getContext().getAuthentication()
        - onLogoutSuccess()
    5 = {UsernamePasswordAuthenticationFilter@8903}
        - AbstractAuthenticationToken
            - setAuthenticated()
            - setDetails()
            - ProviderManager
                - getProviders() -> AuthenticationProvider
                - AnonymousAuthenticationToken
                - UsernamePasswordAuthenticationToken
                    - authenticate()
                    - getName()
                        - getPrincipal()
                            - UserDetails or AuthenticatedPrincipal or Principal
                            - loadUserByUsername
                            - User
        - eraseCredentials()
        - successfulAuthentication()
            - SecurityContextHolder.getContext().setAuthentication(authResult);

    6 = {DefaultLoginPageGeneratingFilter@8904} 
    7 = {DefaultLogoutPageGeneratingFilter@8905} 
    8 = {RequestCacheAwareFilter@8906} 
    9 = {SecurityContextHolderAwareRequestFilter@8907}
        - ThreadLocalSecurityContextHolderStrategy 
    10 = {AnonymousAuthenticationFilter@8908} 
    11 = {SessionManagementFilter@8909} 
    12 = {ExceptionTranslationFilter@8910} 
    13 = {FilterSecurityInterceptor@8911} 
4 = {ApplicationFilterConfig@8923} "ApplicationFilterConfig[name=Tomcat WebSocket (JSR356) Filter, filterClass=org.apache.tomcat.websocket.server.WsFilter]"

```
### 2.1.7. Logout, LogoutFilter
- Logout
    - request("/logout")
    - 세션 무효화
    - 인증 토큰 삭제
    - 쿠키정보 삭제,
    - 로그인 페이지로 리다이렉트

- logout API (로그아웃 처리)
    - logoutUrl()
        - 로그아웃처리 URL
    - logoutSuccessUrl()
        - 로그아웃 성공 후 이동페이지
    - deleteCookies()
        - 로그아웃 후 쿠키삭제
    - addLogoutHandler()
        - 로그아웃 핸들러
    - logoutSuccessHandler()
        - 로그아웃 성공 후 핸들러

- 로그아웃 핸들러
```
0 = {SecurityConfig$4@7841} 
1 = {CookieClearingLogoutHandler@7851} 
2 = {CsrfLogoutHandler@7855} 
3 = {SecurityContextLogoutHandler@7856} 
4 = {LogoutSuccessEventPublishingLogoutHandler@7857} 
```
### 2.1.8. Remember Me 인증

### 2.1.9. RememberMeAuthenticationFilter

### 2.1.10. AnonymousAuthenticationFilter

### 2.1.11. 동시 세션 제어

### 2.1.12. 세션 고정 보호

### 2.1.13. 세션 정책

### 2.1.14. SessionManagementFilter

### 2.1.15. ConcurrentSessionFilter

### 2.1.16. 권한 설정

### 2.1.17 표현식

## 2.2. 인증 / 인가 API

### 2.2.1. ExceptionTranslationFilter

### 2.2.2. AuthenticationException

### 2.2.3. AccessDeniedException

### 2.2.4. RequestCacheAwareFilter